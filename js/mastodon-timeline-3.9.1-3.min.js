const MastodonApi=function(params_){this.CONTAINER_BODY_ID=params_.container_body_id||"mt-body";this.SPINNER_CLASS=params_.spinner_class||"loading-spinner";this.DEFAULT_THEME=params_.default_theme||"auto";this.INSTANCE_URL=params_.instance_url;this.USER_ID=params_.user_id||"";this.PROFILE_NAME=this.USER_ID?params_.profile_name:"";this.TIMELINE_TYPE=params_.timeline_type||"local";this.HASHTAG_NAME=params_.hashtag_name||"";this.TOOTS_LIMIT=params_.toots_limit||"20";this.HIDE_UNLISTED=typeof params_.hide_unlisted!=="undefined"?params_.hide_unlisted:false;this.HIDE_REBLOG=typeof params_.hide_reblog!=="undefined"?params_.hide_reblog:false;this.HIDE_REPLIES=typeof params_.hide_replies!=="undefined"?params_.hide_replies:false;this.HIDE_PREVIEW_LINK=typeof params_.hide_preview_link!=="undefined"?params_.hide_preview_link:false;this.HIDE_EMOJOS=typeof params_.hide_emojos!=="undefined"?params_.hide_emojos:false;this.MARKDOWN_BLOCKQUOTE=typeof params_.markdown_blockquote!=="undefined"?params_.markdown_blockquote:false;this.TEXT_MAX_LINES=params_.text_max_lines||"0";this.LINK_SEE_MORE=params_.link_see_more;this.FETCHED_DATA={};this.mtBodyContainer=document.getElementById(this.CONTAINER_BODY_ID);this.buildTimeline();};MastodonApi.prototype.buildTimeline=async function(){this.setTheme();await this.getTimelineData();this.mtBodyContainer.innerHTML="";for(let i in this.FETCHED_DATA.timeline){if(this.FETCHED_DATA.timeline[i].visibility=="public"||(!this.HIDE_UNLISTED&&this.FETCHED_DATA.timeline[i].visibility=="unlisted")){if((this.HIDE_REBLOG&&this.FETCHED_DATA.timeline[i].reblog)||(this.HIDE_REPLIES&&this.FETCHED_DATA.timeline[i].in_reply_to_id)){}else{this.appendToot(this.FETCHED_DATA.timeline[i],Number(i));}}};if(this.mtBodyContainer.innerHTML===""){this.mtBodyContainer.setAttribute("role","none");this.mtBodyContainer.innerHTML='<div class="mt-error"><span class="mt-error-icon">üì≠</span><br/><strong>Sorry, no toots to show</strong><br/><div class="mt-error-message">Got '+;this.FETCHED_DATA.timeline.length+' toots from the server but due to the "hide filters" applied, no toot is shown</div></div>';}else{if(this.LINK_SEE_MORE){let linkSeeMorePath="";if(this.TIMELINE_TYPE==="profile"){linkSeeMorePath=this.PROFILE_NAME;}else if(this.TIMELINE_TYPE==="hashtag"){linkSeeMorePath="tags/"+this.HASHTAG_NAME;}else if(this.TIMELINE_TYPE==="local"){linkSeeMorePath="public/local";};let linkSeeMore='<div class="mt-footer"><a href="'+;this.INSTANCE_URL+"/"+;linkSeeMorePath+'" class="btn" target="_blank" rel="nofollow noopener noreferrer">'+;this.LINK_SEE_MORE+"</a></div>";this.mtBodyContainer.parentNode.insertAdjacentHTML("beforeend",linkSeeMore);};this.manageSpinner();};this.mtBodyContainer.addEventListener("click",function(e){if(e.target.localName=="article"||e.target.offsetParent.localName=="article"||(e.target.localName=="img"&&e.target.offsetParent.className!=="mt-avatar"&&e.target.offsetParent.className!=="mt-avatar-account")){openTootURL(e);};if(e.target.localName=="button"&&e.target.className=="spoiler-link"){toogleSpoiler(e);}});this.mtBodyContainer.addEventListener("keydown",function(e){if(e.key==="Enter"&&e.target.localName=="article"){openTootURL(e);}});const openTootURL=function(e){let urlToot=e.target.closest(".mt-toot").dataset.location;if(e.target.localName!=="a"&&e.target.localName!=="span"&&e.target.localName!=="button"&&e.target.parentNode.className!=="toot-preview-image"&&urlToot){window.open(urlToot,"_blank");}};const toogleSpoiler=function(e){const nextSibling=e.target.nextSibling;if(nextSibling.localName==="img"){e.target.parentNode.classList.remove("toot-media-spoiler");e.target.style.display="none";}else if(nextSibling.classList.contains("spoiler-text-hidden")||nextSibling.classList.contains("spoiler-text-visible")){if(e.target.textContent=="Show more"){nextSibling.classList.remove("spoiler-text-hidden");nextSibling.classList.add("spoiler-text-visible");e.target.setAttribute("aria-expanded","true");e.target.textContent="Show less";}else{nextSibling.classList.remove("spoiler-text-visible");nextSibling.classList.add("spoiler-text-hidden");e.target.setAttribute("aria-expanded","false");e.target.textContent="Show more";}}};};MastodonApi.prototype.setTheme=function(){const setTheme=function(theme){document.documentElement.setAttribute("data-theme",theme);};if(this.DEFAULT_THEME==="auto"){let systemTheme=window.matchMedia("(prefers-color-scheme: dark)");systemTheme.matches?setTheme("dark"):setTheme("light");systemTheme.addEventListener("change",(e)=>{e.matches?setTheme("dark"):setTheme("light");});}else{setTheme(this.DEFAULT_THEME);}};MastodonApi.prototype.getTimelineData=async function(){return new Promise((resolve,reject)=>{async function fetchData(url){const response=await fetch(url);if(!response.ok){throw new Error("Failed to fetch the following URL: "+;url+"<hr>"+"Error status: "+;response.status+"<hr>"+"Error message: "+;response.statusText);};const data=await response.json();return data;};let urls={};if(this.TIMELINE_TYPE==="profile"){urls.timeline=`${this.INSTANCE_URL}/api/v1/accounts/${this.USER_ID}/statuses?limit=${this.TOOTS_LIMIT}`;}else if(this.TIMELINE_TYPE==="hashtag"){urls.timeline=`${this.INSTANCE_URL}/api/v1/timelines/tag/${this.HASHTAG_NAME}?limit=${this.TOOTS_LIMIT}`;}else if(this.TIMELINE_TYPE==="local"){urls.timeline=`${this.INSTANCE_URL}/api/v1/timelines/public?local=true&limit=${this.TOOTS_LIMIT}`;};if(!this.HIDE_EMOJOS){urls.emojos=this.INSTANCE_URL+"/api/v1/custom_emojis";};const urlsPromises=Object.entries(urls).map(([key,url])=>{return fetchData(url).then((data)=>({[key]:data})).catch((error)=>{reject(new Error("Something went wrong fetching data"));this.mtBodyContainer.innerHTML='<div class="mt-error"><span class="mt-error-icon">‚ùå</span><br/><strong>Sorry, request failed:</strong><br/><div class="mt-error-message">'+;error.message+"</div></div>";this.mtBodyContainer.setAttribute("role","none");return{[key]:[]};});});Promise.all(urlsPromises).then((dataObjects)=>{this.FETCHED_DATA=dataObjects.reduce((result,dataItem)=>{return{...result,...dataItem};},{});resolve();});});};MastodonApi.prototype.appendToot=function(c,i){this.mtBodyContainer.insertAdjacentHTML("beforeend",this.assambleToot(c,i));};MastodonApi.prototype.assambleToot=function(c,i){let avatar,user,content,url,date;if(c.reblog){url=c.reblog.url;avatar='<a href="'+;c.reblog.account.url+'" class="mt-avatar" rel="nofollow noopener noreferrer" target="_blank">'+'<div class="mt-avatar-image">'+'<div class="mt-avatar-boosted">'+'<img src="'+;c.reblog.account.avatar+'" alt="'+;c.reblog.account.username+' avatar" loading="lazy" />'+"</div>"+'<div class="mt-avatar-account">'+'<img src="'+;c.account.avatar+'" alt="'+;c.account.username+' avatar" loading="lazy" />'+"</div>"+"</div>"+"</a>";user='<div class="mt-user">'+'<a href="'+;c.reblog.account.url+'" rel="nofollow noopener noreferrer" target="_blank">'+;(c.reblog.account.display_name?c.reblog.account.display_name:c.reblog.account.username)+'<span class="visually-hidden"> account</span>'+"</a>"+"</div>";date=this.formatDate(c.reblog.created_at);}else{url=c.url;avatar='<a href="'+;c.account.url+'" class="mt-avatar" rel="nofollow noopener noreferrer" target="_blank">'+'<div class="mt-avatar-image">'+'<img src="'+;c.account.avatar+'" alt="'+;c.account.username+' avatar" loading="lazy" />'+"</div>"+"</a>";user='<div class="mt-user">'+'<a href="'+;c.account.url+'" rel="nofollow noopener noreferrer" target="_blank">'+;(c.account.display_name?c.account.display_name:c.account.username)+'<span class="visually-hidden"> account</span>'+"</a>"+"</div>";date=this.formatDate(c.created_at);};let text_css="";if(this.TEXT_MAX_LINES!=="0"){text_css="truncate";document.documentElement.style.setProperty("--text-max-lines",this.TEXT_MAX_LINES);};if(c.spoiler_text!==""){content='<div class="toot-text">'+;c.spoiler_text+' <button type="button" class="spoiler-link" aria-expanded="false">Show more</button>'+'<div class="spoiler-text-hidden">'+;this.formatTootText(c.content)+"</div>"+"</div>";}else if(c.reblog&&c.reblog.content!==""&&c.reblog.spoiler_text!==""){content='<div class="toot-text">'+;c.reblog.spoiler_text+' <button type="button" class="spoiler-link" aria-expanded="false">Show more</button>'+'<div class="spoiler-text-hidden">'+;this.formatTootText(c.reblog.content)+"</div>"+"</div>";}else if(c.reblog&&c.reblog.content!==""&&c.reblog.spoiler_text===""){content='<div class="toot-text '+;text_css+'">'+"<div>"+;this.formatTootText(c.reblog.content)+"</div>"+"</div>";}else{content='<div class="toot-text '+;text_css+'">'+"<div>"+;this.formatTootText(c.content)+"</div>"+"</div>";};let media="";if(c.media_attachments.length>0){for(let picid in c.media_attachments){media=this.placeMedias(c.media_attachments[picid],c.sensitive);}};if(c.reblog&&c.reblog.media_attachments.length>0){for(let picid in c.reblog.media_attachments){media=this.placeMedias(c.reblog.media_attachments[picid],c.reblog.sensitive);}};let preview_link="";if(media===""){if(!this.HIDE_PREVIEW_LINK&&c.card){preview_link=this.placePreviewLink(c.card);}};let poll="";let pollOption="";if(c.poll){for(let i in c.poll.options){pollOption+="<li>"+c.poll.options[i].title+"</li>";};poll='<div class="toot-poll">'+"<ul>"+pollOption+"</ul>"+"</div>";};const timestamp='<div class="toot-date">'+'<a href="'+;url+'" rel="nofollow noopener noreferrer" tabindex="-1" target="_blank">'+;date+"</a>"+"</div>";const toot='<article class="mt-toot" aria-posinset="'+;(i+1)+'" aria-setsize="'+;this.TOOTS_LIMIT+'" data-location="'+;url+'" tabindex="0">'+'<div class="toot-header">'+;avatar+;user+'</div>'+;content+;media+;preview_link+;poll+;timestamp+"</article>";return toot;};MastodonApi.prototype.formatTootText=function(c){let content=c;content=this.addTarget2hashtagMention(content);if(!this.HIDE_EMOJOS){content=this.showEmojos(content,this.FETCHED_DATA.emojos);};if(this.MARKDOWN_BLOCKQUOTE){content=this.replaceHTMLtag(content,"<p>&gt;","</p>","<blockquote><p>","</p></blockquote>");};return content;};MastodonApi.prototype.addTarget2hashtagMention=function(c){let content=c.replaceAll('rel="tag"','rel="tag" target="_blank"');content=content.replaceAll('class="u-url mention"','class="u-url mention" target="_blank"');return content;};MastodonApi.prototype.showEmojos=function(c,e){if(c.includes(":")){for(const emojo of e){const regex=new RegExp(`\\:${emojo.shortcode}\\:`,"g");c=c.replace(regex,`<img src="${emojo.url}"class="custom-emoji"alt="Emoji ${emojo.shortcode}"/>`);};return c;}else{return c;}};MastodonApi.prototype.replaceHTMLtag=function(c,initialTagOpen,initialTagClose,replacedTagOpen,replacedTagClose){if(c.includes(initialTagOpen)){const regex=new RegExp(initialTagOpen+"(.*?)"+initialTagClose,"gi");return c.replace(regex,replacedTagOpen+"$1"+replacedTagClose);}else{return c;}};MastodonApi.prototype.placeMedias=function(m,s){let spoiler=s||false;const pic='<div class="toot-media '+;(spoiler?"toot-media-spoiler":"")+" img-ratio14_7 "+;this.SPINNER_CLASS+'">'+;(spoiler?'<button class="spoiler-link">Show content</button>':"")+'<img src="'+;m.preview_url+'" alt="'+;(m.description?m.description:"")+'" loading="lazy" />'+"</div>";return pic;};MastodonApi.prototype.placePreviewLink=function(c){let card='<a href="'+;c.url+'" class="toot-preview-link" target="_blank" rel="noopener noreferrer">'+;(c.image?'<div class="toot-preview-image '+;this.SPINNER_CLASS+'"><img src="'+;c.image+'" alt="" loading="lazy" /></div>':'<div class="toot-preview-noImage">üìÑ</div>')+"</div>"+'<div class="toot-preview-content">'+;(c.provider_name?'<span class="toot-preview-provider">'+c.provider_name+"</span>":"")+'<span class="toot-preview-title">'+;c.title+"</span>"+;(c.author_name?'<span class="toot-preview-author">By '+c.author_name+"</span>":"")+"</div>"+"</a>";return card;};MastodonApi.prototype.formatDate=function(d){const monthNames=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec",];let date=new Date(d);const displayDate=monthNames[date.getMonth()]+" "+;date.getDate()+", "+;date.getFullYear();return displayDate;};MastodonApi.prototype.manageSpinner=function(){const spinnerCSS=this.SPINNER_CLASS;const removeSpinner=function(){this.parentNode.classList.remove(spinnerCSS);this.removeEventListener("load",removeSpinner);this.removeEventListener("error",removeSpinner);};this.mtBodyContainer.querySelectorAll(`.${this.SPINNER_CLASS}>img`).forEach((e)=>{e.addEventListener("load",removeSpinner);e.addEventListener("error",removeSpinner);});};